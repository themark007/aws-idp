AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS GenAI IDP Accelerator - resources for IDP Pattern 2 (Bedrock FMs)
Parameters:
  StackName:
    Type: String
  InputBucket:
    Type: String
  ConfigurationBucket:
    Type: String
  OutputBucket:
    Type: String
  WorkingBucket:
    Type: String
  TrackingTable:
    Type: String
  CustomerManagedEncryptionKeyArn:
    Type: String
  LogRetentionDays:
    Type: Number
  LogLevel:
    Type: String
    Default: WARN
    AllowedValues:
    - DEBUG
    - INFO
    - WARN
    - ERROR
    - CRITICAL
    Description: Default logging level for all Lambda functions
  AppSyncApiUrl:
    Type: String
    Default: ''
    Description: The AppSync API URL for status updates
  AppSyncApiArn:
    Type: String
    Default: ''
    Description: The AppSync API ARN for IAM permissions
  ExecutionTimeThresholdMs:
    Type: Number
    Default: 30000
  CustomClassificationModelARN:
    Type: String
    Default: ''
  CustomExtractionModelARN:
    Type: String
    Default: ''
  UpdateConfigurationFunctionArn:
    Type: String
  ConfigurationTable:
    Type: String
  BedrockGuardrailId:
    Type: String
    Default: ''
    Description: Optionally provide the Id (not name) of an existing Bedrock Guardrail
      to be used for Bedrock interactions
  BedrockGuardrailVersion:
    Type: String
    Default: ''
    Description: If you provided a Bedrock Guardrail Id above, provide the corresponding
      Guardrail version here
  ConfigurationDefaultS3Uri:
    Type: String
    Description: S3 URI (s3://bucket/path/config.json) to import default configuration
      from S3
  ConfigLibraryHash:
    Type: String
    Description: Hash token from config library to force updates when config library
      changes
  ReportingBucket:
    Type: String
    Description: S3 bucket for evaluation metrics and analytics
  BaselineBucket:
    Type: String
    Description: S3 bucket containing baseline/ground truth documents
  SaveReportingFunctionName:
    Type: String
    Description: Name of Lambda function to save evaluation metrics
  EnableXRayTracing:
    Type: String
    Default: 'true'
    AllowedValues:
    - 'true'
    - 'false'
    Description: Enable X-Ray tracing
  EnableECRImageScanning:
    Type: String
    Default: 'true'
    AllowedValues:
    - 'true'
    - 'false'
    Description: Enable automatic vulnerability scanning for Lambda container images
      in ECR
  PermissionsBoundaryArn:
    Type: String
    Default: ''
    Description: '(Optional) ARN of an existing IAM Permissions Boundary policy to
      attach to all IAM roles. Required by some organizations with Service Control
      Policies (SCPs). Format: arn:partition:iam::account-id:policy/policy-name Leave
      blank if no Permissions Boundary is required.'
    AllowedPattern: ^(|arn:aws[a-z-]*:iam::[0-9]{12}:policy/.+)$
    ConstraintDescription: Must be empty or a valid IAM policy ARN
  ImageVersion:
    Type: String
    Default: latest
    Description: Version tag for Lambda container images (e.g. 0.3.19 or latest)
  ArtifactBucket:
    Type: String
    Description: S3 bucket containing deployment artifacts
  ArtifactPrefix:
    Type: String
    Description: S3 prefix where deployment artifacts are stored
  SourceZipfile:
    Type: String
    Description: Pattern-2 source zipfile object name
Conditions:
  HasGuardrailConfig:
    Fn::And:
    - Fn::Not:
      - Fn::Equals:
        - Ref: BedrockGuardrailId
        - ''
    - Fn::Not:
      - Fn::Equals:
        - Ref: BedrockGuardrailVersion
        - ''
  HasCustomClassificationModelARN:
    Fn::Not:
    - Fn::Equals:
      - Ref: CustomClassificationModelARN
      - ''
  HasCustomExtractionModelARN:
    Fn::Not:
    - Fn::Equals:
      - Ref: CustomExtractionModelARN
      - ''
  HasPermissionsBoundary:
    Fn::Not:
    - Fn::Equals:
      - Ref: PermissionsBoundaryArn
      - ''
  HasAppSyncApi:
    Fn::Not:
    - Fn::Equals:
      - Ref: AppSyncApiArn
      - ''
  IsECRImageScanningEnabled:
    Fn::Equals:
    - Ref: EnableECRImageScanning
    - 'true'
Resources:
  DockerBuildRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Wildcard permissions required for CloudWatch Logs creation
        - id: W12
          reason: Amazon Inspector ListCoverage and ListFindings require wildcard
            resource per AWS documentation
      SamResourceId: DockerBuildRole
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
              Fn::Sub: codebuild.${AWS::URLSuffix}
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      ManagedPolicyArns:
      - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
      Policies:
      - PolicyName: CodeBuildAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Resource:
            - Fn::Sub: arn:${AWS::Partition}:s3:::${ArtifactBucket}
            - Fn::Sub: arn:${AWS::Partition}:s3:::${ArtifactBucket}/${ArtifactPrefix}/*
            Effect: Allow
            Action:
            - s3:GetObject
            - s3:GetObjectVersion
            - s3:GetBucketLocation
            - s3:ListBucket
          - Resource:
            - Fn::Sub: arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/*
            - Fn::Sub: arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/*:*
            Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          - Resource:
            - Fn::GetAtt:
              - ECRRepository
              - Arn
            Effect: Allow
            Action:
            - ecr:DescribeImageScanFindings
            - ecr:DescribeImages
            - ecr:StartImageScan
          - Resource: '*'
            Effect: Allow
            Action:
            - inspector2:ListCoverage
            - inspector2:ListFindings
          - Resource:
            - Ref: CustomerManagedEncryptionKeyArn
            Effect: Allow
            Action:
            - kms:Decrypt
            - kms:CreateGrant
  ECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      ImageScanningConfiguration:
        ScanOnPush:
          Fn::If:
          - IsECRImageScanningEnabled
          - true
          - false
      EncryptionConfiguration:
        EncryptionType: KMS
        KmsKey:
          Ref: CustomerManagedEncryptionKeyArn
      LifecyclePolicy:
        LifecyclePolicyText: "{\n  \"rules\": [{\n    \"rulePriority\": 1,\n    \"\
          description\": \"Keep last 10 images\",\n    \"selection\": {\n      \"\
          tagStatus\": \"any\",\n      \"countType\": \"imageCountMoreThan\",\n  \
          \    \"countNumber\": 10\n    },\n    \"action\": { \"type\": \"expire\"\
          \ }\n  }]\n}\n"
    Metadata:
      SamResourceId: ECRRepository
  DockerBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-docker-build
      Description:
        Fn::Sub: Pattern-2 Docker image builder for GenAIIDP stack - ${AWS::StackName}
      ServiceRole:
        Fn::GetAtt:
        - DockerBuildRole
        - Arn
      EncryptionKey:
        Ref: CustomerManagedEncryptionKeyArn
      Artifacts:
        Type: NO_ARTIFACTS
      Source:
        Location:
          Fn::Sub: arn:${AWS::Partition}:s3:::${ArtifactBucket}/${ArtifactPrefix}/${SourceZipfile}
        Type: S3
        BuildSpec: patterns/pattern-2/buildspec.yml
      Environment:
        ComputeType: BUILD_GENERAL1_LARGE
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        Type: LINUX_CONTAINER
        PrivilegedMode: true
        EnvironmentVariables:
        - Name: ECR_URI
          Value:
            Fn::GetAtt:
            - ECRRepository
            - RepositoryUri
        - Name: IMAGE_VERSION
          Value:
            Ref: ImageVersion
        - Name: AWS_REGION
          Value:
            Ref: AWS::Region
      TimeoutInMinutes: 90
    Metadata:
      SamResourceId: DockerBuildProject
  CodeBuildExecutionRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Role requires * resource access for CloudWatch Logs and CloudFormation
            custom resource operations
      SamResourceId: CodeBuildExecutionRole
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - Fn::Sub: lambda.${AWS::URLSuffix}
          Action:
          - sts:AssumeRole
      Path: /
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      Policies:
      - PolicyName: root
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - codebuild:StartBuild
            - codebuild:BatchGetBuilds
            Resource:
            - Fn::GetAtt:
              - DockerBuildProject
              - Arn
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
          - Effect: Allow
            Action:
            - ecr:ListImages
            - ecr:BatchDeleteImage
            - ecr:DescribeImages
            Resource:
            - Fn::GetAtt:
              - ECRRepository
              - Arn
      - PolicyName: CustomResourcePoller
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - events:PutRule
            - events:DeleteRule
            - events:PutTargets
            - events:RemoveTargets
            Resource:
            - Fn::Sub: arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/*
          - Effect: Allow
            Action:
            - lambda:AddPermission
            - lambda:RemovePermission
            Resource:
            - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:*
  CodeBuildTrigger:
    Type: AWS::Serverless::Function
    Metadata:
      SamResourceId: CodeBuildTrigger
      cfn_nag:
        rules_to_suppress:
        - id: W89
          reason: Function does not require VPC access as it only interacts with AWS
            services via APIs
        - id: W92
          reason: Function does not require reserved concurrency as it scales based
            on demand
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      Role:
        Fn::GetAtt:
        - CodeBuildExecutionRole
        - Arn
      Runtime: python3.12
      Timeout: 60
      MemorySize: 128
      Handler: index.handler
      CodeUri: s3://aws-ml-blog-us-west-2/artifacts/genai-idp/0.4.15/55cb79efb673b97eb15b48062dc24f6d
      Description: CodeBuild trigger Lambda for Docker image builds
      LoggingConfig:
        LogGroup:
          Ref: CodeBuildTriggerLogGroup
  CodeBuildTriggerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/CodeBuildTrigger
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: CodeBuildTriggerLogGroup
  DockerBuildRun:
    Type: Custom::CodeBuildRun
    Properties:
      ServiceToken:
        Fn::GetAtt:
        - CodeBuildTrigger
        - Arn
      BuildProjectName:
        Ref: DockerBuildProject
      CodeLocation:
        Fn::Sub: arn:${AWS::Partition}:s3:::${ArtifactBucket}/${ArtifactPrefix}/${SourceZipfile}
      ImageVersion:
        Ref: ImageVersion
      ExpectedImages:
      - ocr-function
      - classification-function
      - extraction-function
      - assessment-function
      - processresults-function
      - summarization-function
      - evaluation-function
      - rule-validation-function
      - rule-validation-orchestration-function
    Metadata:
      SamResourceId: DockerBuildRun
  EcrRepositoryCleanup:
    Type: Custom::ECRRepositoryCleanup
    DependsOn:
    - DockerBuildRun
    Properties:
      ServiceToken:
        Fn::GetAtt:
        - CodeBuildTrigger
        - Arn
      RepositoryName:
        Ref: ECRRepository
    Metadata:
      SamResourceId: EcrRepositoryCleanup
  LambdaECRAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows Lambda functions to pull container images from ECR
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - ecr:GetDownloadUrlForLayer
          - ecr:BatchGetImage
          - ecr:BatchCheckLayerAvailability
          Resource:
            Fn::Sub: arn:${AWS::Partition}:ecr:${AWS::Region}:${AWS::AccountId}:repository/*
    Metadata:
      SamResourceId: LambdaECRAccessPolicy
  UpdateSchemaConfig:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Ref: UpdateConfigurationFunctionArn
      Schema:
        type: object
        required:
        - notes
        - classes
        - classification
        - extraction
        properties:
          notes:
            order: 0
            type: string
            description: Notes
          ocr:
            order: 1
            type: object
            sectionLabel: OCR Configuration
            required:
            - features
            properties:
              image:
                type: object
                sectionLabel: Image Processing Settings
                description: Configure image resolution and processing options for
                  OCR
                order: 0
                properties:
                  dpi:
                    type: number
                    description: 'DPI (dots per inch) for extracting images from PDF
                      pages. Higher values produce better quality but larger images.
                      Default: 150'
                    minimum: 72
                    maximum: 300
                    default: 150
                    order: 0
                  target_width:
                    type: number
                    description: Target image width in pixels. Images larger than
                      this will be resized. If not specified, automatic default of
                      951 pixels is applied to optimize resource usage and token consumption.
                    minimum: 100
                    maximum: 3500
                    order: 1
                  target_height:
                    type: number
                    description: Target image height in pixels. Images larger than
                      this will be resized. If not specified, automatic default of
                      1268 pixels is applied to optimize resource usage and token
                      consumption.
                    minimum: 100
                    maximum: 3500
                    order: 2
                  preprocessing:
                    type: boolean
                    description: 'Apply adaptive binarization preprocessing to improve
                      OCR accuracy on documents with uneven lighting or low contrast.
                      Warning: May slightly increase processing time.'
                    default: false
                    order: 3
              backend:
                type: string
                description: 'OCR backend to use: ''textract'' for AWS Textract, ''bedrock''
                  for LLM-based OCR, ''none'' for image-only processing without OCR'
                enum:
                - textract
                - bedrock
                - none
                default: textract
                order: 3
              model_id:
                type: string
                description: Bedrock model ID (only used if backend is 'bedrock').
                  Select 'LambdaHook' to use a custom Lambda function for inference.
                enum:
                - LambdaHook
                - us.amazon.nova-lite-v1:0
                - us.amazon.nova-pro-v1:0
                - us.amazon.nova-premier-v1:0
                - us.amazon.nova-2-lite-v1:0
                - us.amazon.nova-2-lite-v1:0:priority
                - us.amazon.nova-2-lite-v1:0:flex
                - global.amazon.nova-2-lite-v1:0
                - global.amazon.nova-2-lite-v1:0:priority
                - global.amazon.nova-2-lite-v1:0:flex
                - us.anthropic.claude-3-haiku-20240307-v1:0
                - us.anthropic.claude-haiku-4-5-20251001-v1:0
                - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - us.anthropic.claude-opus-4-20250514-v1:0
                - us.anthropic.claude-opus-4-1-20250805-v1:0
                - us.anthropic.claude-opus-4-5-20251101-v1:0
                - eu.amazon.nova-lite-v1:0
                - eu.amazon.nova-pro-v1:0
                - eu.amazon.nova-2-lite-v1:0
                - eu.amazon.nova-2-lite-v1:0:priority
                - eu.amazon.nova-2-lite-v1:0:flex
                - eu.anthropic.claude-3-haiku-20240307-v1:0
                - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                - eu.anthropic.claude-sonnet-4-20250514-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - eu.anthropic.claude-opus-4-5-20251101-v1:0
                - qwen.qwen3-vl-235b-a22b
                - global.amazon.nova-2-lite-v1:0
                - global.anthropic.claude-haiku-4-5-20251001-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - global.anthropic.claude-opus-4-5-20251101-v1:0
                order: 2
                dependsOn:
                  field: backend
                  value: bedrock
              model_lambda_hook_arn:
                type: string
                description: Lambda function ARN for custom inference (used when model_id
                  is 'LambdaHook'). Function name must start with GENAIIDP-.
                default: ''
                order: 3
                dependsOn:
                  field: model_id
                  value: LambdaHook
              system_prompt:
                type: string
                description: System prompt for Bedrock OCR (only used if backend is
                  'bedrock')
                default: You are an expert OCR system. Extract all text from the provided
                  image accurately, preserving layout where possible.
                order: 4
                dependsOn:
                  field: backend
                  value: bedrock
              task_prompt:
                type: string
                description: Task prompt for Bedrock OCR (only used if backend is
                  'bedrock')
                default: Extract all text from this document image. Preserve the layout,
                  including paragraphs, tables, and formatting.
                order: 5
                dependsOn:
                  field: backend
                  value: bedrock
              features:
                type: array
                listLabel: Textract Features
                itemLabel: Feature
                description: Textract features (only used if backend is 'textract')
                order: 6
                dependsOn:
                  field: backend
                  values:
                  - textract
                items:
                  type: object
                  required:
                  - name
                  properties:
                    name:
                      type: string
                      description: Feature - select one of the supported OCR feature
                        types
                      enum:
                      - TABLES
                      - FORMS
                      - SIGNATURES
                      - LAYOUT
          classes:
            order: 2
            type: array
            sectionLabel: Class definitions
            listLabel: Classes
            itemLabel: Class
            columns: 2
            items:
              type: object
              required:
              - name
              - description
              - attributes
              properties:
                name:
                  type: string
                  description: Class name
                description:
                  type: string
                  description: Class description. Instruct LLM how to identify the
                    class from the context provided in the classification prompt.
                document_name_regex:
                  type: string
                  description: Optional regex pattern to match against document ID/name.
                    When matched, all pages will be classified as this class type
                    without LLM processing. Use only when all pages should be the
                    same class.
                  order: 2.5
                document_page_content_regex:
                  type: string
                  description: Optional regex pattern to match against page content
                    text. When matched during multi-modal page-level classification,
                    the page will be classified as this class type without LLM processing.
                  order: 2.6
                examples:
                  type: array
                  description: Class few-shot examples
                  listLabel: Few-shot examples
                  itemLabel: Few-shot example
                  items:
                    type: object
                    required:
                    - name
                    - classPrompt
                    - attributesPrompt
                    - imagesPath
                    properties:
                      name:
                        type: string
                        description: Example name
                        order: 0
                      classPrompt:
                        type: string
                        description: Classification prompt as few-shot classification
                          example for this class
                        order: 2
                      attributesPrompt:
                        type: string
                        description: Extraction prompt as few-shot attribute value
                          extraction example for this class.
                        order: 3
                      imagePath:
                        type: string
                        description: Image(s) Path in the Configuration Bucket. Supports
                          single files, or S3 prefixes for folders with multiple images.
                          Optional but recommended for better visual understanding.
                        order: 4
                attributes:
                  type: array
                  listLabel: Attributes
                  itemLabel: Attribute
                  items:
                    type: object
                    required:
                    - name
                    - description
                    - attributeType
                    properties:
                      name:
                        type: string
                        description: Attribute name
                        order: 0
                      description:
                        type: string
                        description: Attribute description. Instruct the LLM how to
                          identify the attribute from the context provided in the
                          extraction prompt. Include synonyms and positional infomation
                          where it might help the LLM to resolve ambiquities.
                        order: 1
                      attributeType:
                        type: string
                        description: Type of attribute
                        enum:
                        - simple
                        - group
                        - list
                        order: 2
                      evaluation_method:
                        type: string
                        description: Evaluation Method
                        enum:
                        - ''
                        - LLM
                        - SEMANTIC
                        - FUZZY
                        - NUMERIC_EXACT
                        - EXACT
                        order: 3
                        dependsOn:
                          field: attributeType
                          value: simple
                      evaluation_threshold:
                        type: number
                        description: Evaluation Threshold - used for SEMANTIC, and
                          FUZZY methods
                        minimum: 0
                        maximum: 1
                        order: 5
                        dependsOn:
                          field: evaluation_method
                          values:
                          - SEMANTIC
                          - FUZZY
                      confidence_threshold:
                        type: number
                        description: Confidence threshold for this specific attribute
                          (0.0 to 1.0). If not set, the default confidence threshold
                          from assessment section will be used.
                        minimum: 0
                        maximum: 1
                        order: 6
                        dependsOn:
                          field: attributeType
                          value: simple
                      groupAttributes:
                        type: array
                        listLabel: Group Attributes
                        itemLabel: Attribute
                        order: 7
                        dependsOn:
                          field: attributeType
                          value: group
                        items:
                          type: object
                          required:
                          - name
                          - description
                          properties:
                            name:
                              type: string
                              description: Attribute name
                              order: 0
                            description:
                              type: string
                              description: Attribute description. Instruct the LLM
                                how to identify the attribute from the context provided
                                in the extraction prompt. Include synonyms and positional
                                infomation where it might help the LLM to resolve
                                ambiquities.
                              order: 1
                            evaluation_method:
                              type: string
                              description: Evaluation Method
                              enum:
                              - ''
                              - LLM
                              - SEMANTIC
                              - FUZZY
                              - NUMERIC_EXACT
                              - EXACT
                              order: 2
                            evaluation_threshold:
                              type: number
                              description: Evaluation Threshold - used for SEMANTIC,
                                and FUZZY methods
                              minimum: 0
                              maximum: 1
                              order: 4
                              dependsOn:
                                field: evaluation_method
                                values:
                                - SEMANTIC
                                - FUZZY
                            confidence_threshold:
                              type: number
                              description: Confidence threshold for this specific
                                attribute (0.0 to 1.0). If not set, the default confidence
                                threshold from assessment section will be used.
                              minimum: 0
                              maximum: 1
                              order: 5
                          columns: 2
                      listItemTemplate:
                        type: object
                        sectionLabel: List Item Template
                        order: 8
                        dependsOn:
                          field: attributeType
                          value: list
                        required:
                        - itemAttributes
                        properties:
                          itemDescription:
                            type: string
                            description: Description of each list item. Instruct the
                              LLM how to identify the list item (e.g. a transaction
                              in a bank statement).
                            order: 0
                          itemAttributes:
                            type: array
                            listLabel: Item Attributes
                            itemLabel: Attribute
                            order: 1
                            items:
                              type: object
                              required:
                              - name
                              - description
                              properties:
                                name:
                                  type: string
                                  description: Attribute name
                                  order: 0
                                description:
                                  type: string
                                  description: Attribute description. Instruct the
                                    LLM how to identify the attribute from the context
                                    provided in the extraction prompt. Include synonyms
                                    and positional infomation where it might help
                                    the LLM to resolve ambiquities.
                                  order: 1
                                evaluation_method:
                                  type: string
                                  description: Evaluation Method
                                  enum:
                                  - ''
                                  - LLM
                                  - SEMANTIC
                                  - FUZZY
                                  - NUMERIC_EXACT
                                  - EXACT
                                  order: 2
                                evaluation_threshold:
                                  type: number
                                  description: Evaluation Threshold - used for SEMANTIC,
                                    and FUZZY methods
                                  minimum: 0
                                  maximum: 1
                                  order: 4
                                  dependsOn:
                                    field: evaluation_method
                                    values:
                                    - SEMANTIC
                                    - FUZZY
                                confidence_threshold:
                                  type: number
                                  description: Confidence threshold for this specific
                                    attribute (0.0 to 1.0). If not set, the default
                                    confidence threshold from assessment section will
                                    be used.
                                  minimum: 0
                                  maximum: 1
                                  order: 5
                              columns: 2
                    columns: 2
          classification:
            order: 3
            type: object
            sectionLabel: Classification Inference
            required:
            - model
            - temperature
            - top_k
            - top_p
            - max_tokens
            - system_prompt
            - task_prompt
            properties:
              image:
                type: object
                sectionLabel: Image Processing Settings
                description: Configure image resolution and processing options for
                  image attachments in classification
                order: 0
                properties:
                  target_width:
                    type: number
                    description: 'Target image width in pixels. Images larger than
                      this will be resized. Default: 951'
                    minimum: 100
                    maximum: 3500
                    order: 0
                  target_height:
                    type: number
                    description: 'Target image height in pixels. Images larger than
                      this will be resized. Default: 1268'
                    minimum: 100
                    maximum: 3500
                    order: 1
              model:
                type: string
                description: Model identifier. Select 'LambdaHook' to use a custom
                  Lambda function for inference.
                enum:
                - LambdaHook
                - Fn::If:
                  - HasCustomClassificationModelARN
                  - Ref: CustomClassificationModelARN
                  - Ref: AWS::NoValue
                - us.amazon.nova-lite-v1:0
                - us.amazon.nova-pro-v1:0
                - us.amazon.nova-premier-v1:0
                - us.amazon.nova-2-lite-v1:0
                - us.amazon.nova-2-lite-v1:0:priority
                - us.amazon.nova-2-lite-v1:0:flex
                - global.amazon.nova-2-lite-v1:0
                - global.amazon.nova-2-lite-v1:0:priority
                - global.amazon.nova-2-lite-v1:0:flex
                - us.anthropic.claude-3-haiku-20240307-v1:0
                - us.anthropic.claude-haiku-4-5-20251001-v1:0
                - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - us.anthropic.claude-opus-4-20250514-v1:0
                - us.anthropic.claude-opus-4-1-20250805-v1:0
                - us.anthropic.claude-opus-4-5-20251101-v1:0
                - eu.amazon.nova-lite-v1:0
                - eu.amazon.nova-pro-v1:0
                - eu.amazon.nova-2-lite-v1:0
                - eu.amazon.nova-2-lite-v1:0:priority
                - eu.amazon.nova-2-lite-v1:0:flex
                - eu.anthropic.claude-3-haiku-20240307-v1:0
                - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                - eu.anthropic.claude-sonnet-4-20250514-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - eu.anthropic.claude-opus-4-5-20251101-v1:0
                - qwen.qwen3-vl-235b-a22b
                - global.amazon.nova-2-lite-v1:0
                - global.anthropic.claude-haiku-4-5-20251001-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - global.anthropic.claude-opus-4-5-20251101-v1:0
                order: 1
              model_lambda_hook_arn:
                type: string
                description: Lambda function ARN for custom inference (used when model
                  is 'LambdaHook'). Function name must start with GENAIIDP-.
                default: ''
                order: 2
                dependsOn:
                  field: model
                  value: LambdaHook
              classificationMethod:
                type: string
                description: Classification methodology to use
                enum:
                - multimodalPageLevelClassification
                - textbasedHolisticClassification
                order: 2
              maxPagesForClassification:
                type: string
                description: Number of pages to use for classification [When set to
                  a number, forces the entire document to be assigned a single class]
                enum:
                - ALL
                - '1'
                - '2'
                - '3'
                - '5'
                - '10'
                order: 3
              sectionSplitting:
                type: string
                description: 'Section splitting strategy: ''disabled'' (entire doc
                  as one section), ''page'' (one section per page - prevents joining
                  same-type documents), ''llm_determined'' (use LLM boundary detection
                  - default)'
                enum:
                - disabled
                - page
                - llm_determined
                default: llm_determined
                order: 3.5
              contextPagesCount:
                type: integer
                description: Number of surrounding pages to include as context for
                  multi-modal page-level classification. Value of 0 means no additional
                  context (default). Value of 1 includes 1 page before and after.
                  Value of 2 includes 2 pages before and after. Only applies to multimodalPageLevelClassification
                  method.
                minimum: 0
                maximum: 5
                default: 0
                order: 3.6
                dependsOn:
                  field: classificationMethod
                  value: multimodalPageLevelClassification
              temperature:
                type: number
                minimum: 0
                maximum: 1
                description: 'Sampling temperature: Controls randomness in model output
                  (0.0 = deterministic, higher = more random). Used when top_p is
                  0. Set temperature=0.0 for consistent, deterministic outputs.'
                order: 4
              top_k:
                type: integer
                minimum: 1
                description: Sampling Top K
                order: 5
              top_p:
                type: number
                description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0).
                  When set to a positive value (> 0), overrides temperature parameter.
                  Set to 0 to use temperature instead.'
                order: 6
              max_tokens:
                type: number
                description: Maximum number of output tokens. Ensure this does not
                  exceed the selected model's limit. See model documentation for details.
                order: 7
              system_prompt:
                type: string
                description: System prompt
                order: 8
              task_prompt:
                type: string
                description: Task prompt - include placeholders {CLASS_NAMES_AND_DESCRIPTIONS}
                  (replaced with the class names and descriptions for all specified
                  classes), {FEW_SHOT_EXAMPLES} (replaced by classPrompt and image
                  data from examples in class definitions), {DOCUMENT_TEXT} (replaced
                  by the OCR output), and for multi-modal classification {DOCUMENT_IMAGE}
                  (replaced by the page image attachment). Optionally use <<CACHEPOINT>>
                  to separate static and dynamic elements of prompt for Bedrock prompt
                  caching.
                order: 9
          extraction:
            order: 4
            type: object
            format: section
            sectionLabel: Extraction Inference
            required:
            - model
            - temperature
            - top_k
            - top_p
            - max_tokens
            - system_prompt
            - task_prompt
            properties:
              agentic:
                type: object
                sectionLabel: Agentic Extraction configuration
                description: If enabled the extraction will happen inside a Strands
                  Agent Loop, that allows the model to retry. Recommnded with Anthropic
                  models, small models likely to fail.
                order: 0
                properties:
                  enabled:
                    type: boolean
                    description: Enable Agentic Extraction
                    order: 0
                    default: false
                  review_agent:
                    type: boolean
                    description: This introduces a second agent to review the first
                      agents work. Only use with highly complex workflows as it increases
                      token usage.
                    order: 1
                    default: false
                  review_agent_model:
                    type: string
                    description: Model to review the initial extraction agents work
                      and correct it if needed, if not specified will default to the
                      same as the extraction model.
                    default: ''
              image:
                type: object
                sectionLabel: Image Processing Settings
                description: Configure image resolution and processing options for
                  for image attachments in extraction
                order: 0
                properties:
                  target_width:
                    type: number
                    description: 'Target image width in pixels. Images larger than
                      this will be resized. Default: 951'
                    minimum: 100
                    maximum: 3500
                    order: 0
                  target_height:
                    type: number
                    description: 'Target image height in pixels. Images larger than
                      this will be resized. Default: 1268'
                    minimum: 100
                    maximum: 3500
                    order: 1
              model:
                type: string
                description: Model identifier. Select 'LambdaHook' to use a custom
                  Lambda function for inference.
                enum:
                - LambdaHook
                - Fn::If:
                  - HasCustomExtractionModelARN
                  - Ref: CustomExtractionModelARN
                  - Ref: AWS::NoValue
                - us.anthropic.claude-sonnet-4-20250514-v1:0
                - us.amazon.nova-lite-v1:0
                - us.amazon.nova-pro-v1:0
                - us.amazon.nova-premier-v1:0
                - us.amazon.nova-2-lite-v1:0
                - us.amazon.nova-2-lite-v1:0:priority
                - us.amazon.nova-2-lite-v1:0:flex
                - global.amazon.nova-2-lite-v1:0
                - global.amazon.nova-2-lite-v1:0:priority
                - global.amazon.nova-2-lite-v1:0:flex
                - us.anthropic.claude-3-haiku-20240307-v1:0
                - us.anthropic.claude-haiku-4-5-20251001-v1:0
                - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - us.anthropic.claude-opus-4-20250514-v1:0
                - us.anthropic.claude-opus-4-1-20250805-v1:0
                - us.anthropic.claude-opus-4-5-20251101-v1:0
                - eu.amazon.nova-lite-v1:0
                - eu.amazon.nova-pro-v1:0
                - eu.amazon.nova-2-lite-v1:0
                - eu.amazon.nova-2-lite-v1:0:priority
                - eu.amazon.nova-2-lite-v1:0:flex
                - eu.anthropic.claude-3-haiku-20240307-v1:0
                - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                - eu.anthropic.claude-sonnet-4-20250514-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - eu.anthropic.claude-opus-4-5-20251101-v1:0
                - qwen.qwen3-vl-235b-a22b
                - global.amazon.nova-2-lite-v1:0
                - global.anthropic.claude-haiku-4-5-20251001-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - global.anthropic.claude-opus-4-5-20251101-v1:0
                order: 1
              model_lambda_hook_arn:
                type: string
                description: Lambda function ARN for custom inference (used when model
                  is 'LambdaHook'). Function name must start with GENAIIDP-.
                default: ''
                order: 2
                dependsOn:
                  field: model
                  value: LambdaHook
              temperature:
                type: number
                minimum: 0
                maximum: 1
                description: 'Sampling temperature: Controls randomness in model output
                  (0.0 = deterministic, higher = more random). Used when top_p is
                  0. Set temperature=0.0 for consistent, deterministic outputs.'
                order: 3
              top_k:
                type: integer
                minimum: 1
                description: Sampling Top K
                order: 4
              top_p:
                type: number
                description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0).
                  When set to a positive value (> 0), overrides temperature parameter.
                  Set to 0 to use temperature instead.'
                order: 5
              max_tokens:
                type: number
                description: Maximum number of output tokens. Ensure this does not
                  exceed the selected model's limit. See model documentation for details.
                order: 6
              system_prompt:
                type: string
                description: System prompt
                order: 7
              task_prompt:
                type: string
                description: Task prompt - supports placeholders {DOCUMENT_CLASS}
                  (replaced with the detected class label), {ATTRIBUTE_NAMES_AND_DESCRIPTIONS}
                  (replaced with the attribute names and descriptions for the detected
                  class), {FEW_SHOT_EXAMPLES} (replaced by classPrompt and image data
                  from examples in class definitions), {DOCUMENT_TEXT} (replaced by
                  the OCR output), and {DOCUMENT_IMAGE} (replaced by the page image
                  attachments for each page). Optionally use <<CACHEPOINT>> to separate
                  static and dynamic elements of prompt for Bedrock prompt caching.
                order: 8
              custom_prompt_lambda_arn:
                type: string
                description: '(Optional) ARN of a Lambda function to generate custom
                  extraction prompts. Function name must start with ''GENAIIDP-''.
                  If not provided, default prompts will be used. The Lambda function
                  receives the complete config, prompt placeholders, default task
                  prompt content, and serialized document, and returns custom system_prompt
                  and task_prompt_content. Example: arn:partition:lambda:us-east-1:123456789012:function:GENAIIDP-my-extractor'
                order: 9
          assessment:
            order: 5
            type: object
            sectionLabel: Assessment Inference
            properties:
              enabled:
                type: boolean
                description: Enable or disable assessment processing
                default: true
                order: 0
              validation_enabled:
                type: boolean
                description: Enable or disable assessment validation checks
                default: false
                order: 1
                dependsOn:
                  field: enabled
                  value: true
              image:
                type: object
                sectionLabel: Image Processing Settings
                description: Configure image resolution and processing options for
                  for image attachments in assessment
                order: 2
                properties:
                  target_width:
                    type: number
                    description: 'Target image width in pixels. Images larger than
                      this will be resized. Default: 951'
                    minimum: 100
                    maximum: 3500
                    order: 0
                  target_height:
                    type: number
                    description: 'Target image height in pixels. Images larger than
                      this will be resized. Default: 1268'
                    minimum: 100
                    maximum: 3500
                    order: 1
              granular:
                type: object
                sectionLabel: Granular Assessment Configuration
                description: Configure granular assessment for improved accuracy and
                  scalability with large documents
                order: 3
                properties:
                  enabled:
                    type: boolean
                    description: Enable granular assessment approach. When enabled,
                      assessments are broken down into smaller, focused tasks for
                      better accuracy and performance.
                    default: true
                    order: 0
                  max_workers:
                    type: integer
                    description: Maximum number of parallel workers for concurrent
                      assessment tasks. Higher values increase throughput but consume
                      more resources.
                    minimum: 1
                    maximum: 20
                    default: 4
                    order: 1
                    dependsOn:
                      field: enabled
                      value: true
                  simple_batch_size:
                    type: integer
                    description: Number of simple attributes to group together in
                      each assessment task. Smaller batches provide more focused assessments.
                    minimum: 1
                    maximum: 10
                    default: 3
                    order: 2
                    dependsOn:
                      field: enabled
                      value: true
                  list_batch_size:
                    type: integer
                    description: Number of list items to process in each assessment
                      task. Usually 1 for best accuracy, can be increased for speed.
                    minimum: 1
                    maximum: 5
                    default: 1
                    order: 3
                    dependsOn:
                      field: enabled
                      value: true
              hitl_enabled:
                type: boolean
                description: Enable Human-in-the-Loop (HITL) review for low confidence
                  extractions
                default: false
                order: 4
              default_confidence_threshold:
                type: number
                description: Confidence Threshold (0.0-1.0) - Documents with confidence
                  below this threshold will trigger HITL review and show confidence
                  alerts
                minimum: 0.0
                maximum: 1.0
                default: 0.8
                order: 5
              model:
                type: string
                description: Bedrock model ID. Select 'LambdaHook' to use a custom
                  Lambda function for inference.
                enum:
                - LambdaHook
                - us.amazon.nova-lite-v1:0
                - us.amazon.nova-pro-v1:0
                - us.amazon.nova-premier-v1:0
                - us.amazon.nova-2-lite-v1:0
                - us.amazon.nova-2-lite-v1:0:priority
                - us.amazon.nova-2-lite-v1:0:flex
                - global.amazon.nova-2-lite-v1:0
                - global.amazon.nova-2-lite-v1:0:priority
                - global.amazon.nova-2-lite-v1:0:flex
                - us.anthropic.claude-3-haiku-20240307-v1:0
                - us.anthropic.claude-haiku-4-5-20251001-v1:0
                - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - us.anthropic.claude-opus-4-20250514-v1:0
                - us.anthropic.claude-opus-4-1-20250805-v1:0
                - us.anthropic.claude-opus-4-5-20251101-v1:0
                - eu.amazon.nova-lite-v1:0
                - eu.amazon.nova-pro-v1:0
                - eu.amazon.nova-2-lite-v1:0
                - eu.amazon.nova-2-lite-v1:0:priority
                - eu.amazon.nova-2-lite-v1:0:flex
                - eu.anthropic.claude-3-haiku-20240307-v1:0
                - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                - eu.anthropic.claude-sonnet-4-20250514-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - eu.anthropic.claude-opus-4-5-20251101-v1:0
                - qwen.qwen3-vl-235b-a22b
                - global.amazon.nova-2-lite-v1:0
                - global.anthropic.claude-haiku-4-5-20251001-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - global.anthropic.claude-opus-4-5-20251101-v1:0
                order: 5
              model_lambda_hook_arn:
                type: string
                description: Lambda function ARN for custom inference (used when model
                  is 'LambdaHook'). Function name must start with GENAIIDP-.
                default: ''
                order: 6
                dependsOn:
                  field: model
                  value: LambdaHook
              temperature:
                type: number
                description: 'Sampling temperature: Controls randomness in model output
                  (0.0 = deterministic, higher = more random). Used when top_p is
                  0. Set temperature=0.0 for consistent, deterministic outputs.'
                order: 7
              top_k:
                type: number
                description: Sampling Top K
                order: 8
              top_p:
                type: number
                description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0).
                  When set to a positive value (> 0), overrides temperature parameter.
                  Set to 0 to use temperature instead.'
                order: 9
              max_tokens:
                type: number
                description: Maximum number of output tokens. Ensure this does not
                  exceed the selected model's limit. See model documentation for details.
                order: 10
              system_prompt:
                type: string
                format: textarea
                description: System prompt
                order: 11
              task_prompt:
                type: string
                format: textarea
                description: Task prompt - supports placeholders {DOCUMENT_TEXT} (markdown
                  text), {OCR_TEXT_CONFIDENCE} (OCR text blocks with confidence),
                  {DOCUMENT_CLASS}, {ATTRIBUTE_NAMES_AND_DESCRIPTIONS}, {EXTRACTION_RESULTS},
                  {GRANULAR_CONTEXT} and {DOCUMENT_IMAGE}. Use <<CACHEPOINT>> to separate
                  static and dynamic elements of prompt for Bedrock prompt caching.
                order: 12
          summarization:
            order: 6
            type: object
            sectionLabel: Summarization Inference
            properties:
              enabled:
                type: boolean
                description: Enable or disable document summarization
                default: true
                order: 0
              model:
                type: string
                description: Bedrock model ID. Select 'LambdaHook' to use a custom
                  Lambda function for inference.
                enum:
                - LambdaHook
                - us.amazon.nova-lite-v1:0
                - us.amazon.nova-pro-v1:0
                - us.amazon.nova-premier-v1:0
                - us.amazon.nova-2-lite-v1:0
                - us.amazon.nova-2-lite-v1:0:priority
                - us.amazon.nova-2-lite-v1:0:flex
                - global.amazon.nova-2-lite-v1:0
                - global.amazon.nova-2-lite-v1:0:priority
                - global.amazon.nova-2-lite-v1:0:flex
                - us.anthropic.claude-3-haiku-20240307-v1:0
                - us.anthropic.claude-haiku-4-5-20251001-v1:0
                - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0
                - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - us.anthropic.claude-opus-4-20250514-v1:0
                - us.anthropic.claude-opus-4-1-20250805-v1:0
                - us.anthropic.claude-opus-4-5-20251101-v1:0
                - eu.amazon.nova-lite-v1:0
                - eu.amazon.nova-pro-v1:0
                - eu.amazon.nova-2-lite-v1:0
                - eu.amazon.nova-2-lite-v1:0:priority
                - eu.amazon.nova-2-lite-v1:0:flex
                - eu.anthropic.claude-3-haiku-20240307-v1:0
                - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                - eu.anthropic.claude-sonnet-4-20250514-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - eu.anthropic.claude-opus-4-5-20251101-v1:0
                - qwen.qwen3-vl-235b-a22b
                - global.amazon.nova-2-lite-v1:0
                - global.anthropic.claude-haiku-4-5-20251001-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                - global.anthropic.claude-opus-4-5-20251101-v1:0
                order: 1
              model_lambda_hook_arn:
                type: string
                description: Lambda function ARN for custom inference (used when model
                  is 'LambdaHook'). Function name must start with GENAIIDP-.
                default: ''
                order: 2
                dependsOn:
                  field: model
                  value: LambdaHook
              temperature:
                type: number
                description: Sampling temperature
                order: 3
              top_k:
                type: number
                description: Sampling Top K
                order: 4
              top_p:
                type: number
                description: Sampling Top P
                order: 5
              max_tokens:
                type: number
                description: Maximum number of output tokens. Ensure this does not
                  exceed the selected model's limit. See model documentation for details.
                order: 6
              system_prompt:
                type: string
                format: textarea
                description: System prompt
                order: 7
              task_prompt:
                type: string
                format: textarea
                description: Task prompt - supports parameters {DOCUMENT_TEXT} and
                  {EXTRACTION_RESULTS}. Optionally use <<CACHEPOINT>> to separate
                  static and dynamic elements of prompt for Bedrock prompt caching.
                order: 8
          evaluation:
            order: 7
            type: object
            sectionLabel: Evaluation Inference
            properties:
              enabled:
                type: boolean
                description: Enable or disable evaluation processing
                default: true
                order: 0
              llm_method:
                type: object
                properties:
                  model:
                    type: string
                    description: Bedrock model ID
                    enum:
                    - us.amazon.nova-lite-v1:0
                    - us.amazon.nova-pro-v1:0
                    - us.amazon.nova-premier-v1:0
                    - us.amazon.nova-2-lite-v1:0
                    - us.amazon.nova-2-lite-v1:0:priority
                    - us.amazon.nova-2-lite-v1:0:flex
                    - global.amazon.nova-2-lite-v1:0
                    - global.amazon.nova-2-lite-v1:0:priority
                    - global.amazon.nova-2-lite-v1:0:flex
                    - us.anthropic.claude-3-haiku-20240307-v1:0
                    - us.anthropic.claude-haiku-4-5-20251001-v1:0
                    - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - us.anthropic.claude-opus-4-20250514-v1:0
                    - us.anthropic.claude-opus-4-1-20250805-v1:0
                    - us.anthropic.claude-opus-4-5-20251101-v1:0
                    - eu.amazon.nova-lite-v1:0
                    - eu.amazon.nova-pro-v1:0
                    - eu.amazon.nova-2-lite-v1:0
                    - eu.amazon.nova-2-lite-v1:0:priority
                    - eu.amazon.nova-2-lite-v1:0:flex
                    - eu.anthropic.claude-3-haiku-20240307-v1:0
                    - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                    - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - eu.anthropic.claude-sonnet-4-20250514-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - eu.anthropic.claude-opus-4-5-20251101-v1:0
                    - qwen.qwen3-vl-235b-a22b
                    - global.amazon.nova-2-lite-v1:0
                    - global.anthropic.claude-haiku-4-5-20251001-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - global.anthropic.claude-opus-4-5-20251101-v1:0
                    order: 1
                  temperature:
                    type: number
                    description: 'Sampling temperature: Controls randomness in model
                      output (0.0 = deterministic, higher = more random). Used when
                      top_p is 0. Set temperature=0.0 for consistent, deterministic
                      outputs.'
                    default: 0.0
                    order: 2
                  top_k:
                    type: number
                    description: Sampling Top K
                    default: 250
                    order: 3
                  top_p:
                    type: number
                    description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0).
                      When set to a positive value (> 0), overrides temperature parameter.
                      Set to 0 to use temperature instead.'
                    order: 4
                  max_tokens:
                    type: number
                    description: Maximum number of output tokens. Ensure this does
                      not exceed the selected model's limit. See model documentation
                      for details.
                    order: 5
                  system_prompt:
                    type: string
                    format: textarea
                    description: System prompt for LLM evaluation
                    order: 6
                  task_prompt:
                    type: string
                    format: textarea
                    description: Task prompt for LLM evaluation - supports placeholders
                      {DOCUMENT_CLASS}, {ATTRIBUTE_NAME}, {ATTRIBUTE_DESCRIPTION},
                      {EXPECTED_VALUE} and {ACTUAL_VALUE}
                    order: 7
          discovery:
            order: 8
            type: object
            sectionLabel: Discovery Configuration
            description: Configuration for document class discovery functionality
            properties:
              without_ground_truth:
                order: 0
                type: object
                sectionLabel: Discovery Without Ground Truth
                description: Configuration for discovering document classes without
                  reference data
                properties:
                  model_id:
                    type: string
                    description: Bedrock model ID for discovery without ground truth
                    enum:
                    - us.amazon.nova-lite-v1:0
                    - us.amazon.nova-pro-v1:0
                    - us.amazon.nova-premier-v1:0
                    - us.amazon.nova-2-lite-v1:0
                    - us.amazon.nova-2-lite-v1:0:priority
                    - us.amazon.nova-2-lite-v1:0:flex
                    - global.amazon.nova-2-lite-v1:0
                    - global.amazon.nova-2-lite-v1:0:priority
                    - global.amazon.nova-2-lite-v1:0:flex
                    - us.anthropic.claude-3-haiku-20240307-v1:0
                    - us.anthropic.claude-haiku-4-5-20251001-v1:0
                    - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - us.anthropic.claude-opus-4-20250514-v1:0
                    - us.anthropic.claude-opus-4-1-20250805-v1:0
                    - us.anthropic.claude-opus-4-5-20251101-v1:0
                    - eu.amazon.nova-lite-v1:0
                    - eu.amazon.nova-pro-v1:0
                    - eu.amazon.nova-2-lite-v1:0
                    - eu.amazon.nova-2-lite-v1:0:priority
                    - eu.amazon.nova-2-lite-v1:0:flex
                    - eu.anthropic.claude-3-haiku-20240307-v1:0
                    - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                    - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - eu.anthropic.claude-sonnet-4-20250514-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - eu.anthropic.claude-opus-4-5-20251101-v1:0
                    - qwen.qwen3-vl-235b-a22b
                    - global.amazon.nova-2-lite-v1:0
                    - global.anthropic.claude-haiku-4-5-20251001-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - global.anthropic.claude-opus-4-5-20251101-v1:0
                    default: us.amazon.nova-pro-v1:0
                    order: 0
                  temperature:
                    type: number
                    description: 'Sampling temperature: Controls randomness in model
                      output (0.0 = deterministic, higher = more random). Used when
                      top_p is 0. Set temperature=0.0 for consistent, deterministic
                      outputs.'
                    minimum: 0.0
                    maximum: 1.0
                    default: 1.0
                    order: 1
                  top_p:
                    type: number
                    description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0).
                      When set to a positive value (> 0), overrides temperature parameter.
                      Set to 0 to use temperature instead.'
                    minimum: 0.0
                    maximum: 1.0
                    default: 0.1
                    order: 2
                  max_tokens:
                    type: number
                    description: Maximum number of output tokens. Ensure this does
                      not exceed the selected model's limit. See model documentation
                      for details.
                    minimum: 1000
                    maximum: 20000
                    default: 10000
                    order: 3
                  system_prompt:
                    type: string
                    format: textarea
                    description: System prompt for the discovery model
                    default: You are an expert in processing forms. Extracting data
                      from images and documents. Analyze forms line by line to identify
                      field names, data types, and organizational structure. Focus
                      on creating comprehensive blueprints for document processing
                      without extracting actual values.
                    order: 4
                  user_prompt:
                    type: string
                    format: textarea
                    description: User prompt template for discovery without ground
                      truth
                    default: This image contains forms data. Analyze the form line
                      by line. Image may contains multiple pages, process all the
                      pages. Form may contain multiple name value pair in one line.
                      Extract all the names in the form including the name value pair
                      which doesn't have value. Organize them into groups, extract
                      field_name, data_type and field description. Field_name should
                      be less than 60 characters, should not have space use '-' instead
                      of space. field_description is a brief description of the field
                      and the location of the field like box number or line number
                      in the form and section of the form. Field_name should be unique
                      within the group. Add two fields document_class and document_description.
                      For document_class generate a short name based on the document
                      content like W4, I-9, Paystub. For document_description generate
                      a description about the document in less than 50 words. Group
                      the fields based on the section they are grouped in the form.
                      Group should have attributeType as "group". If the group repeats,
                      add an additional field groupType and set the value as "Table".
                      Do not extract the values. Return the extracted data in JSON
                      format.
                    order: 5
              with_ground_truth:
                order: 1
                type: object
                sectionLabel: Discovery With Ground Truth
                description: Configuration for discovering document classes using
                  reference data
                properties:
                  model_id:
                    type: string
                    description: Bedrock model ID for discovery with ground truth
                    enum:
                    - us.amazon.nova-lite-v1:0
                    - us.amazon.nova-pro-v1:0
                    - us.amazon.nova-premier-v1:0
                    - us.amazon.nova-2-lite-v1:0
                    - us.amazon.nova-2-lite-v1:0:priority
                    - us.amazon.nova-2-lite-v1:0:flex
                    - global.amazon.nova-2-lite-v1:0
                    - global.amazon.nova-2-lite-v1:0:priority
                    - global.amazon.nova-2-lite-v1:0:flex
                    - us.anthropic.claude-3-haiku-20240307-v1:0
                    - us.anthropic.claude-haiku-4-5-20251001-v1:0
                    - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - us.anthropic.claude-opus-4-20250514-v1:0
                    - us.anthropic.claude-opus-4-1-20250805-v1:0
                    - us.anthropic.claude-opus-4-5-20251101-v1:0
                    - eu.amazon.nova-lite-v1:0
                    - eu.amazon.nova-pro-v1:0
                    - eu.amazon.nova-2-lite-v1:0
                    - eu.amazon.nova-2-lite-v1:0:priority
                    - eu.amazon.nova-2-lite-v1:0:flex
                    - eu.anthropic.claude-3-haiku-20240307-v1:0
                    - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                    - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - eu.anthropic.claude-sonnet-4-20250514-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - eu.anthropic.claude-opus-4-5-20251101-v1:0
                    - qwen.qwen3-vl-235b-a22b
                    - global.amazon.nova-2-lite-v1:0
                    - global.anthropic.claude-haiku-4-5-20251001-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - global.anthropic.claude-opus-4-5-20251101-v1:0
                    default: us.amazon.nova-pro-v1:0
                    order: 0
                  temperature:
                    type: number
                    description: 'Sampling temperature: Controls randomness in model
                      output (0.0 = deterministic, higher = more random). Used when
                      top_p is 0. Set temperature=0.0 for consistent, deterministic
                      outputs.'
                    minimum: 0.0
                    maximum: 1.0
                    default: 1.0
                    order: 1
                  top_p:
                    type: number
                    description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0).
                      When set to a positive value (> 0), overrides temperature parameter.
                      Set to 0 to use temperature instead.'
                    minimum: 0.0
                    maximum: 1.0
                    default: 0.1
                    order: 2
                  max_tokens:
                    type: number
                    description: Maximum number of output tokens. Ensure this does
                      not exceed the selected model's limit. See model documentation
                      for details.
                    minimum: 1000
                    maximum: 20000
                    default: 10000
                    order: 3
                  system_prompt:
                    type: string
                    format: textarea
                    description: System prompt for the discovery model with ground
                      truth
                    default: You are an expert in processing forms. Extracting data
                      from images and documents. Use provided ground truth data as
                      reference to optimize field extraction and ensure consistency
                      with expected document structure and field definitions.
                    order: 4
                  user_prompt:
                    type: string
                    format: textarea
                    description: User prompt template for discovery with ground truth
                      (use {ground_truth_json} placeholder)
                    default: This image contains unstructured data. Analyze the data
                      line by line using the provided ground truth as reference. <GROUND_TRUTH_REFERENCE>{ground_truth_json}</GROUND_TRUTH_REFERENCE>
                      Ground truth reference JSON has the fields we are interested
                      in extracting from the document/image. Use the ground truth
                      to optimize field extraction. Match field names, data types,
                      and groupings from the reference. Image may contain multiple
                      pages, process all pages. Extract all field names including
                      those without values. Do not change the group name and field
                      name from ground truth in the extracted data json. Add field_description
                      field for every field which will contain instruction to LLM
                      to extract the field data from the image/document. Add data_type
                      field for every field. Add two fields document_class and document_description.
                      For document_class generate a short name based on the document
                      content like W4, I-9, Paystub. For document_description generate
                      a description about the document in less than 50 words. If the
                      group repeats and follows table format, add a special field
                      group_type with value "Table" and description field for the
                      group. Do not extract the values.
                    order: 5
              output_format:
                order: 2
                type: object
                sectionLabel: Output Format Configuration
                description: Configuration for discovery output format
                properties:
                  sample_json:
                    type: string
                    format: textarea
                    description: Sample JSON format for discovery output
                    default: "{\n  \"document_class\": \"Form-1040\",\n  \"document_description\"\
                      : \"Brief summary of the document\",\n  \"groups\": [\n    {\n\
                      \      \"name\": \"PersonalInformation\",\n      \"description\"\
                      : \"Personal information of Tax payer\",\n      \"attributeType\"\
                      : \"group\",\n      \"groupType\": \"normal\",\n      \"groupAttributes\"\
                      : [\n        {\n          \"name\": \"FirstName\",\n       \
                      \   \"dataType\": \"string\",\n          \"description\": \"\
                      First Name of Taxpayer\"\n        },\n        {\n          \"\
                      name\": \"Age\",\n          \"dataType\": \"number\",\n    \
                      \      \"description\": \"Age of Taxpayer\"\n        }\n   \
                      \   ]\n    }\n  ]\n}"
                    order: 0
          agents:
            order: 9
            type: object
            sectionLabel: Agent Configuration
            description: Configuration for AI agents used in the system
            properties:
              chat_companion:
                type: object
                sectionLabel: Chat Companion Agents
                description: Configuration for the chat companion agents
                properties:
                  model_id:
                    type: string
                    description: Model ID for the chat companion agents
                    enum:
                    - us.amazon.nova-lite-v1:0
                    - us.amazon.nova-pro-v1:0
                    - us.amazon.nova-premier-v1:0
                    - us.amazon.nova-2-lite-v1:0
                    - us.amazon.nova-2-lite-v1:0:priority
                    - us.amazon.nova-2-lite-v1:0:flex
                    - global.amazon.nova-2-lite-v1:0
                    - global.amazon.nova-2-lite-v1:0:priority
                    - global.amazon.nova-2-lite-v1:0:flex
                    - us.anthropic.claude-3-haiku-20240307-v1:0
                    - us.anthropic.claude-haiku-4-5-20251001-v1:0
                    - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - us.anthropic.claude-opus-4-20250514-v1:0
                    - us.anthropic.claude-opus-4-1-20250805-v1:0
                    - us.anthropic.claude-opus-4-5-20251101-v1:0
                    - global.anthropic.claude-haiku-4-5-20251001-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - global.anthropic.claude-opus-4-5-20251101-v1:0
                    - eu.amazon.nova-lite-v1:0
                    - eu.amazon.nova-pro-v1:0
                    - eu.amazon.nova-2-lite-v1:0
                    - eu.amazon.nova-2-lite-v1:0:priority
                    - eu.amazon.nova-2-lite-v1:0:flex
                    - eu.anthropic.claude-3-haiku-20240307-v1:0
                    - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                    - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - eu.anthropic.claude-sonnet-4-20250514-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - eu.anthropic.claude-opus-4-5-20251101-v1:0
                    - qwen.qwen3-vl-235b-a22b
                    default: us.anthropic.claude-haiku-4-5-20251001-v1:0
                    order: 0
              error_analyzer:
                type: object
                sectionLabel: Error Analysis Agent
                description: Configuration for the error analysis agent
                properties:
                  system_prompt:
                    type: string
                    format: textarea
                    description: System prompt for the error analysis agent
                    order: 1
                  parameters:
                    type: object
                    sectionLabel: Agent Parameters
                    description: Configuration parameters for the agent
                    properties:
                      max_log_events:
                        type: integer
                        description: Maximum number of log events to analyze
                        default: 100
                        order: 0
                      time_range_hours_default:
                        type: integer
                        description: Default time range in hours for analysis
                        default: 24
                        order: 2
          rule_validation:
            order: 10
            type: object
            sectionLabel: Rule Validation Inference
            properties:
              enabled:
                type: boolean
                description: Enable or disable rule validation processing
                default: true
                order: 0
              recommendation_options:
                type: string
                format: text-area
                description: 'Recommendation options that define the possible outcomes
                  for rule validation: Pass (criteria fully met), Fail (partially
                  met or needs more info), Information Not Found (no relevant data)'
                default: 'Pass: The requirement criteria are fully met.

                  Fail: The requirement is partially met or requires additional information.

                  Information Not Found: No relevant data exists in the user history.'
                order: 1
                dependsOn:
                  field: enabled
                  value: true
              semaphore:
                type: integer
                minimum: 1
                maximum: 10
                description: Number of concurrent API calls for rule validation
                default: 5
                order: 2
                dependsOn:
                  field: enabled
                  value: true
              max_chunk_size:
                type: integer
                minimum: 1000
                maximum: 200000
                description: Maximum chunk size (in characters) for rule validation
                  processing
                default: 8000
                order: 3
                dependsOn:
                  field: enabled
                  value: true
              fact_extraction:
                type: object
                sectionLabel: Fact Extraction
                description: Configuration for extracting relevant facts from documents
                order: 4
                dependsOn:
                  field: enabled
                  value: true
                properties:
                  model:
                    type: string
                    description: Bedrock model ID for fact extraction
                    enum:
                    - us.amazon.nova-lite-v1:0
                    - us.amazon.nova-pro-v1:0
                    - us.amazon.nova-premier-v1:0
                    - us.amazon.nova-2-lite-v1:0
                    - us.amazon.nova-2-lite-v1:0:priority
                    - us.amazon.nova-2-lite-v1:0:flex
                    - global.amazon.nova-2-lite-v1:0
                    - global.amazon.nova-2-lite-v1:0:priority
                    - global.amazon.nova-2-lite-v1:0:flex
                    - us.anthropic.claude-3-haiku-20240307-v1:0
                    - us.anthropic.claude-haiku-4-5-20251001-v1:0
                    - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - us.anthropic.claude-3-5-sonnet-20240620-v1:0
                    - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - us.anthropic.claude-opus-4-20250514-v1:0
                    - us.anthropic.claude-opus-4-1-20250805-v1:0
                    - us.anthropic.claude-opus-4-5-20251101-v1:0
                    - eu.amazon.nova-lite-v1:0
                    - eu.amazon.nova-pro-v1:0
                    - eu.amazon.nova-2-lite-v1:0
                    - eu.amazon.nova-2-lite-v1:0:priority
                    - eu.amazon.nova-2-lite-v1:0:flex
                    - eu.anthropic.claude-3-haiku-20240307-v1:0
                    - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                    - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - eu.anthropic.claude-sonnet-4-20250514-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - eu.anthropic.claude-opus-4-5-20251101-v1:0
                    - qwen.qwen3-vl-235b-a22b
                    - global.amazon.nova-2-lite-v1:0
                    - global.anthropic.claude-haiku-4-5-20251001-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - global.anthropic.claude-opus-4-5-20251101-v1:0
                    default: us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    order: 0
                  temperature:
                    type: number
                    minimum: 0
                    maximum: 1
                    description: 'Sampling temperature: Controls randomness in model
                      output (0.0 = deterministic, higher = more random)'
                    default: 0.0
                    order: 1
                  top_k:
                    type: integer
                    minimum: 1
                    description: Sampling Top K
                    default: 20
                    order: 2
                  top_p:
                    type: number
                    description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0)'
                    default: 0.01
                    order: 3
                  max_tokens:
                    type: integer
                    description: Maximum number of output tokens. Ensure this does
                      not exceed the selected model's limit. See model documentation
                      for details.
                    default: 4096
                    order: 4
                  system_prompt:
                    type: string
                    format: textarea
                    description: System prompt that defines the LLM's role as a fact
                      extractor for identifying relevant information from documents
                    order: 5
                  task_prompt:
                    type: string
                    format: textarea
                    description: Task prompt for fact extraction - supports placeholders
                      {DOCUMENT_TEXT} (replaced with document content), {recommendation_options}
                      (replaced with available recommendation options), {rule_type}
                      (replaced with rule type), and {rule} (replaced with rule description).
                      Optionally use <<CACHEPOINT>> to separate static and dynamic
                      elements of prompt for Bedrock prompt caching.
                    order: 6
              rule_validation_orchestrator:
                type: object
                sectionLabel: Rule Validation Orchestrator
                description: Configuration for consolidating fact extraction results
                  into final compliance decisions
                order: 5
                dependsOn:
                  field: enabled
                  value: true
                properties:
                  model:
                    type: string
                    description: Bedrock model ID for rule validation orchestrator
                    enum:
                    - us.amazon.nova-lite-v1:0
                    - us.amazon.nova-pro-v1:0
                    - us.amazon.nova-premier-v1:0
                    - us.amazon.nova-2-lite-v1:0
                    - us.amazon.nova-2-lite-v1:0:priority
                    - us.amazon.nova-2-lite-v1:0:flex
                    - global.amazon.nova-2-lite-v1:0
                    - global.amazon.nova-2-lite-v1:0:priority
                    - global.amazon.nova-2-lite-v1:0:flex
                    - us.anthropic.claude-3-haiku-20240307-v1:0
                    - us.anthropic.claude-haiku-4-5-20251001-v1:0
                    - us.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - us.anthropic.claude-3-5-sonnet-20240620-v1:0
                    - us.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0
                    - us.anthropic.claude-sonnet-4-20250514-v1:0:1m
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - us.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - us.anthropic.claude-opus-4-20250514-v1:0
                    - us.anthropic.claude-opus-4-1-20250805-v1:0
                    - us.anthropic.claude-opus-4-5-20251101-v1:0
                    - eu.amazon.nova-lite-v1:0
                    - eu.amazon.nova-pro-v1:0
                    - eu.amazon.nova-2-lite-v1:0
                    - eu.amazon.nova-2-lite-v1:0:priority
                    - eu.amazon.nova-2-lite-v1:0:flex
                    - eu.anthropic.claude-3-haiku-20240307-v1:0
                    - eu.anthropic.claude-haiku-4-5-20251001-v1:0
                    - eu.anthropic.claude-3-5-sonnet-20241022-v2:0
                    - eu.anthropic.claude-3-7-sonnet-20250219-v1:0
                    - eu.anthropic.claude-sonnet-4-20250514-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - eu.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - eu.anthropic.claude-opus-4-5-20251101-v1:0
                    - qwen.qwen3-vl-235b-a22b
                    - global.amazon.nova-2-lite-v1:0
                    - global.anthropic.claude-haiku-4-5-20251001-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0
                    - global.anthropic.claude-sonnet-4-5-20250929-v1:0:1m
                    - global.anthropic.claude-opus-4-5-20251101-v1:0
                    default: us.anthropic.claude-sonnet-4-5-20250929-v1:0
                    order: 0
                  temperature:
                    type: number
                    minimum: 0
                    maximum: 1
                    description: 'Sampling temperature: Controls randomness in model
                      output (0.0 = deterministic, higher = more random)'
                    default: 0.0
                    order: 1
                  top_k:
                    type: integer
                    minimum: 1
                    description: Sampling Top K
                    default: 20
                    order: 2
                  top_p:
                    type: number
                    description: 'Sampling Top P: Nucleus sampling threshold (0.0-1.0)'
                    default: 0.01
                    order: 3
                  max_tokens:
                    type: integer
                    description: Maximum number of output tokens. Ensure this does
                      not exceed the selected model's limit. See model documentation
                      for details.
                    default: 4096
                    order: 4
                  system_prompt:
                    type: string
                    format: textarea
                    description: System prompt for rule validation orchestrator -
                      defines the LLM's role in consolidating extracted facts into
                      final compliance decisions
                    order: 5
                  task_prompt:
                    type: string
                    format: textarea
                    description: Task prompt for rule validation orchestrator - supports
                      placeholders {recommendation_options}, {extracted_evidence},
                      {policy_class}, and {rule}. Optionally use <<CACHEPOINT>> to
                      separate static and dynamic elements of prompt for Bedrock prompt
                      caching.
                    order: 6
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      SamResourceId: UpdateSchemaConfig
  UpdateDefaultConfig:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Ref: UpdateConfigurationFunctionArn
      Default:
        Ref: ConfigurationDefaultS3Uri
      DefaultPricing:
        Fn::Sub: s3://${ConfigurationBucket}/config_library/pricing.yaml
      ConfigLibraryHash:
        Ref: ConfigLibraryHash
      CustomClassificationModelARN:
        Ref: CustomClassificationModelARN
      CustomExtractionModelARN:
        Ref: CustomExtractionModelARN
    Metadata:
      SamResourceId: UpdateDefaultConfig
  OCRFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
        - id: W11
          reason: Textract DetectDocumentText API and Cloudwatch APIs do not support
            resource-level permissions
      SamResourceId: OCRFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:ocr-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 2048
      Tracing: Active
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          MAX_WORKERS: 20
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          TRACKING_TABLE:
            Ref: TrackingTable
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
      LoggingConfig:
        LogGroup:
          Ref: OCRFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Effect: Allow
          Action:
          - textract:DetectDocumentText
          - textract:AnalyzeDocument
          Resource: '*'
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
        - Effect: Allow
          Action:
          - aws-marketplace:Subscribe
          - aws-marketplace:Unsubscribe
          - aws-marketplace:ViewSubscriptions
          Resource: '*'
        - Effect: Allow
          Action: lambda:InvokeFunction
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:GENAIIDP-*
          Condition:
            StringLike:
              lambda:FunctionName: GENAIIDP-*
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
  OCRFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/OCRFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: OCRFunctionLogGroup
  ClassificationFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Cloudwatch does not support resource-level permissions
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
      SamResourceId: ClassificationFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:classification-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 2048
      Tracing: Active
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          MAX_WORKERS: 20
          TRACKING_TABLE:
            Ref: TrackingTable
          CONFIGURATION_BUCKET:
            Ref: ConfigurationBucket
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
      LoggingConfig:
        LogGroup:
          Ref: ClassificationFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - S3ReadPolicy:
          BucketName:
            Ref: ConfigurationBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
          - Fn::If:
            - HasCustomClassificationModelARN
            - Ref: CustomClassificationModelARN
            - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - aws-marketplace:Subscribe
          - aws-marketplace:Unsubscribe
          - aws-marketplace:ViewSubscriptions
          Resource: '*'
        - Effect: Allow
          Action: lambda:InvokeFunction
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:GENAIIDP-*
          Condition:
            StringLike:
              lambda:FunctionName: GENAIIDP-*
        - Fn::If:
          - HasGuardrailConfig
          - Effect: Allow
            Action: bedrock:ApplyGuardrail
            Resource:
              Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}
          - Ref: AWS::NoValue
  ClassificationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/ClassificationFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: ClassificationFunctionLogGroup
  ExtractionFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
        - id: W11
          reason: Cloudwatch does not support resource-level permissions, and Bedrock
            should support any enabled Bedrock model_id or inference profile
        - id: W76
          reason: 'Suppressing W76: SPCM for IAM policy document is higher than 25'
      SamResourceId: ExtractionFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:extraction-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 512
      Tracing: Active
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          CONFIGURATION_BUCKET:
            Ref: ConfigurationBucket
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          GUARDRAIL_ID_AND_VERSION:
            Fn::If:
            - HasGuardrailConfig
            - Fn::Sub: ${BedrockGuardrailId}:${BedrockGuardrailVersion}
            - ''
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          TRACKING_TABLE:
            Ref: TrackingTable
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
      LoggingConfig:
        LogGroup:
          Ref: ExtractionFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - S3ReadPolicy:
          BucketName:
            Ref: ConfigurationBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
          - Fn::If:
            - HasCustomExtractionModelARN
            - Ref: CustomExtractionModelARN
            - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - aws-marketplace:Subscribe
          - aws-marketplace:Unsubscribe
          - aws-marketplace:ViewSubscriptions
          Resource: '*'
        - Effect: Allow
          Action: lambda:InvokeFunction
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:GENAIIDP-*
          Condition:
            StringLike:
              lambda:FunctionName: GENAIIDP-*
        - Fn::If:
          - HasGuardrailConfig
          - Effect: Allow
            Action: bedrock:ApplyGuardrail
            Resource:
              Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}
          - Ref: AWS::NoValue
  ExtractionFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/ExtractionFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: ExtractionFunctionLogGroup
  AssessmentFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
        - id: W11
          reason: Cloudwatch does not support resource-level permissions, and Bedrock
            should support any enabled Bedrock model_id or inference profile
      SamResourceId: AssessmentFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:assessment-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 512
      Tracing: Active
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          CONFIGURATION_BUCKET:
            Ref: ConfigurationBucket
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          TRACKING_TABLE:
            Ref: TrackingTable
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
      LoggingConfig:
        LogGroup:
          Ref: AssessmentFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - S3ReadPolicy:
          BucketName:
            Ref: ConfigurationBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
        - Effect: Allow
          Action:
          - aws-marketplace:Subscribe
          - aws-marketplace:Unsubscribe
          - aws-marketplace:ViewSubscriptions
          Resource: '*'
        - Effect: Allow
          Action: lambda:InvokeFunction
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:GENAIIDP-*
          Condition:
            StringLike:
              lambda:FunctionName: GENAIIDP-*
        - Fn::If:
          - HasGuardrailConfig
          - Effect: Allow
            Action: bedrock:ApplyGuardrail
            Resource:
              Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}
          - Ref: AWS::NoValue
  AssessmentFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/AssessmentFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: AssessmentFunctionLogGroup
  ProcessResultsFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Cloudwatch does not support resource-level permissions
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
      SamResourceId: ProcessResultsFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:processresults-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          TRACKING_TABLE:
            Ref: TrackingTable
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
          OUTPUT_BUCKET:
            Ref: OutputBucket
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
      LoggingConfig:
        LogGroup:
          Ref: ProcessResultsFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
  ProcessResultsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/ProcessResultsFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: ProcessResultsFunctionLogGroup
  SummarizationFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Cloudwatch does not support resource-level permissions
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
      SamResourceId: SummarizationFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:summarization-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          GUARDRAIL_ID_AND_VERSION:
            Fn::If:
            - HasGuardrailConfig
            - Fn::Sub: ${BedrockGuardrailId}:${BedrockGuardrailVersion}
            - ''
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          TRACKING_TABLE:
            Ref: TrackingTable
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
      LoggingConfig:
        LogGroup:
          Ref: SummarizationFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
        - Effect: Allow
          Action:
          - aws-marketplace:Subscribe
          - aws-marketplace:Unsubscribe
          - aws-marketplace:ViewSubscriptions
          Resource: '*'
        - Effect: Allow
          Action: lambda:InvokeFunction
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:GENAIIDP-*
          Condition:
            StringLike:
              lambda:FunctionName: GENAIIDP-*
        - Fn::If:
          - HasGuardrailConfig
          - Effect: Allow
            Action: bedrock:ApplyGuardrail
            Resource:
              Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}
          - Ref: AWS::NoValue
  SummarizationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/SummarizationFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: SummarizationFunctionLogGroup
  EvaluationFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Role requires * resource access for CloudWatch Metrics and Logs
        - id: W89
          reason: Function does not require VPC access as it only interacts with AWS
            services via APIs
        - id: W92
          reason: Function does not require reserved concurrency as it scales based
            on demand
      SamResourceId: EvaluationFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:evaluation-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 1024
      Tracing: Active
      Environment:
        Variables:
          LOG_LEVEL:
            Ref: LogLevel
          METRIC_NAMESPACE:
            Ref: StackName
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          PROCESSING_OUTPUT_BUCKET:
            Ref: OutputBucket
          EVALUATION_OUTPUT_BUCKET:
            Ref: OutputBucket
          REPORTING_BUCKET:
            Ref: ReportingBucket
          BASELINE_BUCKET:
            Ref: BaselineBucket
          SAVE_REPORTING_FUNCTION_NAME:
            Ref: SaveReportingFunctionName
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          WORKING_BUCKET:
            Ref: WorkingBucket
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          TRACKING_TABLE:
            Ref: TrackingTable
      LoggingConfig:
        LogGroup:
          Ref: EvaluationFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: ConfigurationTable
      - S3ReadPolicy:
          BucketName:
            Ref: BaselineBucket
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
        - Effect: Allow
          Action:
          - lambda:InvokeFunction
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${SaveReportingFunctionName}
  EvaluationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/EvaluationFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: EvaluationFunctionLogGroup
  RuleValidationFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Cloudwatch does not support resource-level permissions
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
      SamResourceId: RuleValidationFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:rule-validation-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          GUARDRAIL_ID_AND_VERSION:
            Fn::If:
            - HasGuardrailConfig
            - Fn::Sub: ${BedrockGuardrailId}:${BedrockGuardrailVersion}
            - ''
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          TRACKING_TABLE:
            Ref: TrackingTable
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
      LoggingConfig:
        LogGroup:
          Ref: RuleValidationFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
        - Fn::If:
          - HasGuardrailConfig
          - Effect: Allow
            Action: bedrock:ApplyGuardrail
            Resource:
              Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}
          - Ref: AWS::NoValue
  RuleValidationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/RuleValidationFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: RuleValidationFunctionLogGroup
  RuleValidationOrchestrationFunction:
    Type: AWS::Serverless::Function
    DependsOn: DockerBuildRun
    Metadata:
      SkipBuild: true
      cfn_nag:
        rules_to_suppress:
        - id: W11
          reason: Cloudwatch does not support resource-level permissions
        - id: W89
          reason: This Lambda function does not require VPC access as it only interacts
            with AWS services via AWS APIs
        - id: W92
          reason: Function does not require concurrent execution limits as it is designed
            to scale based on demand
      SamResourceId: RuleValidationOrchestrationFunction
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      PackageType: Image
      ImageUri:
        Fn::Sub: ${ECRRepository.RepositoryUri}:rule-validation-orchestration-function-${ImageVersion}
      Architectures:
      - arm64
      ImageConfig:
        Command:
        - index.handler
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          METRIC_NAMESPACE:
            Ref: StackName
          CONFIGURATION_TABLE_NAME:
            Ref: ConfigurationTable
          GUARDRAIL_ID_AND_VERSION:
            Fn::If:
            - HasGuardrailConfig
            - Fn::Sub: ${BedrockGuardrailId}:${BedrockGuardrailVersion}
            - ''
          LOG_LEVEL:
            Ref: LogLevel
          APPSYNC_API_URL:
            Ref: AppSyncApiUrl
          TRACKING_TABLE:
            Ref: TrackingTable
          DOCUMENT_TRACKING_MODE:
            Fn::If:
            - HasAppSyncApi
            - appsync
            - dynamodb
          WORKING_BUCKET:
            Ref: WorkingBucket
          REPORTING_BUCKET:
            Ref: ReportingBucket
          SAVE_REPORTING_FUNCTION_NAME:
            Ref: SaveReportingFunctionName
      LoggingConfig:
        LogGroup:
          Ref: RuleValidationOrchestrationFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaECRAccessPolicy
      - S3ReadPolicy:
          BucketName:
            Ref: InputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: OutputBucket
      - S3CrudPolicy:
          BucketName:
            Ref: WorkingBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConfigurationTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TrackingTable
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource:
            Ref: CustomerManagedEncryptionKeyArn
        - Fn::If:
          - HasAppSyncApi
          - Effect: Allow
            Action:
            - appsync:GraphQL
            Resource:
            - Fn::Sub: ${AppSyncApiArn}/types/Mutation/*
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:bedrock:*::foundation-model/*
          - Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*
        - Effect: Allow
          Action:
          - aws-marketplace:Subscribe
          - aws-marketplace:Unsubscribe
          - aws-marketplace:ViewSubscriptions
          Resource: '*'
        - Fn::If:
          - HasGuardrailConfig
          - Effect: Allow
            Action:
            - bedrock:ApplyGuardrail
            Resource:
              Fn::Sub: arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}
          - Ref: AWS::NoValue
        - Effect: Allow
          Action:
          - lambda:InvokeFunction
          Resource:
            Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${SaveReportingFunctionName}
  RuleValidationOrchestrationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /${AWS::StackName}/lambda/RuleValidationOrchestrationFunction
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: RuleValidationOrchestrationFunctionLogGroup
  DocumentProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      PermissionsBoundary:
        Fn::If:
        - HasPermissionsBoundary
        - Ref: PermissionsBoundaryArn
        - Ref: AWS::NoValue
      Name:
        Fn::Sub: ${AWS::StackName}-DocumentProcessingWorkflow
      DefinitionUri:
        Bucket: aws-ml-blog-us-west-2
        Key: artifacts/genai-idp/0.4.15/1edc6f56eb77126f6eb678fa87b703d6
      DefinitionSubstitutions:
        OCRFunctionArn:
          Fn::GetAtt:
          - OCRFunction
          - Arn
        ClassificationFunctionArn:
          Fn::GetAtt:
          - ClassificationFunction
          - Arn
        ExtractionFunctionArn:
          Fn::GetAtt:
          - ExtractionFunction
          - Arn
        AssessmentFunctionArn:
          Fn::GetAtt:
          - AssessmentFunction
          - Arn
        ProcessResultsLambdaArn:
          Fn::GetAtt:
          - ProcessResultsFunction
          - Arn
        SummarizationLambdaArn:
          Fn::GetAtt:
          - SummarizationFunction
          - Arn
        EvaluationLambdaArn:
          Fn::GetAtt:
          - EvaluationFunction
          - Arn
        RuleValidationLambdaArn:
          Fn::GetAtt:
          - RuleValidationFunction
          - Arn
        RuleValidationOrchestrationLambdaArn:
          Fn::GetAtt:
          - RuleValidationOrchestrationFunction
          - Arn
        OutputBucket:
          Ref: OutputBucket
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
        - CloudWatchLogsLogGroup:
            Fn::GetAtt:
            - StateMachineLogGroup
            - Arn
      Tracing:
        Enabled:
          Ref: EnableXRayTracing
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: OCRFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: ClassificationFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: ExtractionFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: AssessmentFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: ProcessResultsFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: SummarizationFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: EvaluationFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: RuleValidationFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: RuleValidationOrchestrationFunction
      - CloudWatchLogsFullAccess
    Metadata:
      SamResourceId: DocumentProcessingStateMachine
  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId:
        Ref: CustomerManagedEncryptionKeyArn
      LogGroupName:
        Fn::Sub: /aws/vendedlogs/states/${AWS::StackName}/workflow
      RetentionInDays:
        Ref: LogRetentionDays
    Metadata:
      SamResourceId: StateMachineLogGroup
  Dashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName:
        Fn::Sub: ${AWS::StackName}-${AWS::Region}-Pattern2-Subset
      DashboardBody:
        Fn::Sub: "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"\
          x\": 0,\n      \"y\": 0,\n      \"width\": 8,\n      \"height\": 6,\n  \
          \    \"properties\": {\n        \"metrics\": [\n          [{\"expression\"\
          : \"m1/PERIOD(m1)*60\", \"label\": \"Documents per Minute\"}],\n       \
          \   [\"${StackName}\", \"InputDocuments\", {\"id\": \"m1\", \"stat\": \"\
          Sum\", \"visible\": false}]\n        ],\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Input Documents (per Minute)\",\n        \"view\"\
          : \"timeSeries\",\n        \"period\": 60,\n        \"yAxis\": {\n     \
          \     \"left\": {\n            \"label\": \"Count per Minute\"\n       \
          \   }\n        }\n      }\n    },\n    {\n      \"type\": \"metric\",\n\
          \      \"x\": 8,\n      \"y\": 0,\n      \"width\": 8,\n      \"height\"\
          : 6,\n      \"properties\": {\n        \"metrics\": [\n          [{\"expression\"\
          : \"m1/PERIOD(m1)*60\", \"label\": \"Pages per Minute\"}],\n          [\"\
          ${StackName}\", \"InputDocumentPages\", {\"id\": \"m1\", \"stat\": \"Sum\"\
          , \"visible\": false}]\n        ],\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Input Document Pages (per Minute)\",\n        \"\
          view\": \"timeSeries\",\n        \"period\": 60,\n        \"yAxis\": {\n\
          \          \"left\": {\n            \"label\": \"Count per Minute\"\n  \
          \        }\n        }\n      }\n    },\n    {\n      \"type\": \"metric\"\
          ,\n      \"x\": 16,\n      \"y\": 0,\n      \"width\": 8,\n      \"height\"\
          : 6,\n      \"properties\": {\n        \"metrics\": [],\n        \"region\"\
          : \"${AWS::Region}\",\n        \"title\": \"Blank\",\n        \"view\":\
          \ \"timeSeries\",\n        \"period\": 60,\n        \"yAxis\": {\n     \
          \     \"left\": {\n            \"label\": \"N/A\"\n          }\n       \
          \ }\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 0,\n\
          \      \"y\": 6,\n      \"width\": 8,\n      \"height\": 6,\n      \"properties\"\
          : {\n        \"metrics\": [\n          [{\"expression\": \"m1/PERIOD(m1)*60\"\
          , \"label\": \"Tokens per Minute (TPM)\"}],\n          [{\"expression\"\
          : \"m2/PERIOD(m1)*60\", \"label\": \"Cache Read TPM\"}],\n          [{\"\
          expression\": \"m3/PERIOD(m1)*60\", \"label\": \"Cache Write TPM\"}],\n\
          \          [\"${StackName}\", \"InputTokens\", {\"id\": \"m1\", \"stat\"\
          : \"Sum\", \"visible\": false}],\n          [\".\", \"CacheReadInputTokens\"\
          , {\"id\": \"m2\", \"stat\": \"Sum\", \"visible\": false}],\n          [\"\
          .\", \"CacheWriteInputTokens\", {\"id\": \"m3\", \"stat\": \"Sum\", \"visible\"\
          : false}]\n        ],\n        \"region\": \"${AWS::Region}\",\n       \
          \ \"title\": \"Input Tokens (per Minute)\",\n        \"view\": \"timeSeries\"\
          ,\n        \"period\": 60,\n        \"yAxis\": {\n          \"left\": {\n\
          \            \"label\": \"Count per Minute\"\n          }\n        }\n \
          \     }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 8,\n \
          \     \"y\": 6,\n      \"width\": 8,\n      \"height\": 6,\n      \"properties\"\
          : {\n        \"metrics\": [\n          [{\"expression\": \"m1/PERIOD(m1)*60\"\
          , \"label\": \"Tokens per Minute (TPM)\"}],\n          [\"${StackName}\"\
          , \"OutputTokens\", {\"id\": \"m1\", \"stat\": \"Sum\", \"visible\": false}]\n\
          \        ],\n        \"region\": \"${AWS::Region}\",\n        \"title\"\
          : \"Output Tokens (per Minute)\",\n        \"view\": \"timeSeries\",\n \
          \       \"period\": 60,\n        \"yAxis\": {\n          \"left\": {\n \
          \           \"label\": \"Count per Minute\"\n          }\n        }\n  \
          \    }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 16,\n \
          \     \"y\": 6,\n      \"width\": 8,\n      \"height\": 6,\n      \"properties\"\
          : {\n        \"metrics\": [\n          [{\"expression\": \"m1/PERIOD(m1)*60\"\
          , \"label\": \"Tokens per Minute\"}],\n          [\"${StackName}\", \"TotalTokens\"\
          , {\"id\": \"m1\", \"stat\": \"Sum\", \"visible\": false}]\n        ],\n\
          \        \"region\": \"${AWS::Region}\",\n        \"title\": \"Total Tokens\
          \ (per Minute)\",\n        \"view\": \"timeSeries\",\n        \"period\"\
          : 60,\n        \"yAxis\": {\n          \"left\": {\n            \"label\"\
          : \"Count per Minute\"\n          }\n        }\n      }\n    },\n    {\n\
          \      \"type\": \"metric\",\n      \"x\": 0,\n      \"y\": 12,\n      \"\
          width\": 8,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\"\
          : [\n          [{\"expression\": \"m1/PERIOD(m1)*60\", \"label\": \"Total\
          \ per Minute\"}],\n          [{\"expression\": \"m2/PERIOD(m2)*60\", \"\
          label\": \"Succeeded per Minute\"}],\n          [{\"expression\": \"m3/PERIOD(m3)*60\"\
          , \"label\": \"Failed per Minute\"}],\n          [\"${StackName}\", \"BedrockRequestsTotal\"\
          , {\"id\": \"m1\", \"stat\": \"Sum\", \"visible\": false}],\n          [\"\
          .\", \"BedrockRequestsSucceeded\", {\"id\": \"m2\", \"stat\": \"Sum\", \"\
          visible\": false}],\n          [\".\", \"BedrockRequestsFailed\", {\"id\"\
          : \"m3\", \"stat\": \"Sum\", \"visible\": false}]\n        ],\n        \"\
          region\": \"${AWS::Region}\",\n        \"title\": \"Bedrock Request Status\
          \ (per Minute)\",\n        \"view\": \"timeSeries\",\n        \"period\"\
          : 60,\n        \"yAxis\": {\n          \"left\": {\n            \"label\"\
          : \"Count per Minute\"\n          }\n        }\n      }\n    },\n    {\n\
          \      \"type\": \"metric\",\n      \"x\": 8,\n      \"y\": 12,\n      \"\
          width\": 8,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\"\
          : [\n          [{\"expression\": \"m1/PERIOD(m1)*60\", \"label\": \"Throttles\
          \ per Minute\"}],\n          [{\"expression\": \"m2/PERIOD(m2)*60\", \"\
          label\": \"Retry Success per Minute\"}],\n          [{\"expression\": \"\
          m3/PERIOD(m3)*60\", \"label\": \"Max Retries Exceeded per Minute\"}],\n\
          \          [\"${StackName}\", \"BedrockThrottles\", {\"id\": \"m1\", \"\
          stat\": \"Sum\", \"visible\": false}],\n          [\".\", \"BedrockRetrySuccess\"\
          , {\"id\": \"m2\", \"stat\": \"Sum\", \"visible\": false}],\n          [\"\
          .\", \"BedrockMaxRetriesExceeded\", {\"id\": \"m3\", \"stat\": \"Sum\",\
          \ \"visible\": false}]\n        ],\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Bedrock Retries (per Minute)\",\n        \"view\"\
          : \"timeSeries\",\n        \"period\": 60,\n        \"yAxis\": {\n     \
          \     \"left\": {\n            \"label\": \"Count per Minute\"\n       \
          \   }\n        }\n      }\n    },\n    {\n      \"type\": \"metric\",\n\
          \      \"x\": 16,\n      \"y\": 12,\n      \"width\": 8,\n      \"height\"\
          : 6,\n      \"properties\": {\n        \"metrics\": [\n          [\"${StackName}\"\
          , \"BedrockRequestLatency\", {\"stat\": \"Average\"}],\n          [\".\"\
          , \"BedrockRequestLatency\", {\"stat\": \"p90\"}],\n          [\".\", \"\
          BedrockRequestLatency\", {\"stat\": \"Maximum\"}],\n          [\".\", \"\
          BedrockTotalLatency\", {\"stat\": \"Average\"}],\n          [\".\", \"BedrockTotalLatency\"\
          , {\"stat\": \"p90\"}],\n          [\".\", \"BedrockTotalLatency\", {\"\
          stat\": \"Maximum\"}]\n        ],\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Bedrock Latency - per request, and total (including\
          \ backoff/retries)\",\n        \"period\": 300,\n        \"view\": \"timeSeries\"\
          ,\n        \"stacked\": false,\n        \"annotations\": {\n          \"\
          horizontal\": [{\n            \"value\": ${ExecutionTimeThresholdMs},\n\
          \            \"label\": \"Threshold (${ExecutionTimeThresholdMs}ms)\",\n\
          \            \"color\": \"#ff0000\"\n          }]\n        }\n      }\n\
          \    },\n    {\n      \"type\": \"metric\",\n      \"x\": 0,\n      \"y\"\
          : 18,\n      \"width\": 8,\n      \"height\": 6,\n      \"properties\":\
          \ {\n        \"metrics\": [\n          [\"AWS/Lambda\", \"Duration\", \"\
          FunctionName\", \"${OCRFunction}\"]\n        ],\n        \"region\": \"\
          ${AWS::Region}\",\n        \"title\": \"OCR Function Duration\",\n     \
          \   \"period\": 300,\n        \"annotations\": {\n          \"horizontal\"\
          : [{\n            \"value\": ${ExecutionTimeThresholdMs},\n            \"\
          label\": \"Threshold (${ExecutionTimeThresholdMs}ms)\",\n            \"\
          color\": \"#ff0000\"\n          }]\n        },\n        \"stat\": \"Average\"\
          ,\n        \"view\": \"timeSeries\"\n      }\n    },\n    {\n      \"type\"\
          : \"metric\",\n      \"x\": 8,\n      \"y\": 18,\n      \"width\": 8,\n\
          \      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n\
          \          [\"AWS/Lambda\", \"Duration\", \"FunctionName\", \"${ClassificationFunction}\"\
          ]\n        ],\n        \"region\": \"${AWS::Region}\",\n        \"title\"\
          : \"Classification Function Duration\",\n        \"period\": 300,\n    \
          \    \"annotations\": {\n          \"horizontal\": [{\n            \"value\"\
          : ${ExecutionTimeThresholdMs},\n            \"label\": \"Threshold (${ExecutionTimeThresholdMs}ms)\"\
          ,\n            \"color\": \"#ff0000\"\n          }]\n        },\n      \
          \  \"stat\": \"Average\",\n        \"view\": \"timeSeries\"\n      }\n \
          \   },\n    {\n      \"type\": \"metric\",\n      \"x\": 16,\n      \"y\"\
          : 18,\n      \"width\": 8,\n      \"height\": 6,\n      \"properties\":\
          \ {\n        \"metrics\": [\n          [\"AWS/Lambda\", \"Duration\", \"\
          FunctionName\", \"${ExtractionFunction}\"]\n        ],\n        \"region\"\
          : \"${AWS::Region}\",\n        \"title\": \"Extraction Function Duration\"\
          ,\n        \"period\": 300,\n        \"annotations\": {\n          \"horizontal\"\
          : [{\n            \"value\": ${ExecutionTimeThresholdMs},\n            \"\
          label\": \"Threshold (${ExecutionTimeThresholdMs}ms)\",\n            \"\
          color\": \"#ff0000\"\n          }]\n        },\n        \"stat\": \"Average\"\
          ,\n        \"view\": \"timeSeries\"\n      }\n    },\n    {\n      \"type\"\
          : \"metric\",\n      \"x\": 0,\n      \"y\": 24,\n      \"width\": 8,\n\
          \      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n\
          \          [\"AWS/Lambda\", \"Duration\", \"FunctionName\", \"${AssessmentFunction}\"\
          ]\n        ],\n        \"region\": \"${AWS::Region}\",\n        \"title\"\
          : \"Assessment Function Duration\",\n        \"period\": 300,\n        \"\
          annotations\": {\n          \"horizontal\": [{\n            \"value\": ${ExecutionTimeThresholdMs},\n\
          \            \"label\": \"Threshold (${ExecutionTimeThresholdMs}ms)\",\n\
          \            \"color\": \"#ff0000\"\n          }]\n        },\n        \"\
          stat\": \"Average\",\n        \"view\": \"timeSeries\"\n      }\n    },\n\
          \    {\n      \"type\": \"metric\",\n      \"x\": 8,\n      \"y\": 24,\n\
          \      \"width\": 8,\n      \"height\": 6,\n      \"properties\": {\n  \
          \      \"metrics\": [\n          [\"AWS/Lambda\", \"Duration\", \"FunctionName\"\
          , \"${SummarizationFunction}\"]\n        ],\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Summarization Function Duration\",\n        \"period\"\
          : 300,\n        \"annotations\": {\n          \"horizontal\": [{\n     \
          \       \"value\": ${ExecutionTimeThresholdMs},\n            \"label\":\
          \ \"Threshold (${ExecutionTimeThresholdMs}ms)\",\n            \"color\"\
          : \"#ff0000\"\n          }]\n        },\n        \"stat\": \"Average\",\n\
          \        \"view\": \"timeSeries\"\n      }\n    },\n    {\n      \"type\"\
          : \"log\",\n      \"x\": 0,\n      \"y\": 24,\n      \"width\": 12,\n  \
          \    \"height\": 6,\n      \"properties\": {\n        \"query\": \"SOURCE\
          \ '${OCRFunctionLogGroup}' | filter @type = \\\"REPORT\\\" | fields @timestamp,\
          \ @logStream, @billedDuration, @maxMemoryUsed/1024/1024 as memoryUsedMB\
          \ | filter @billedDuration > ${ExecutionTimeThresholdMs} | sort by @billedDuration\
          \ desc | limit 20\",\n        \"region\": \"${AWS::Region}\",\n        \"\
          title\": \"OCR Lambda Long Running Invocations\",\n        \"view\": \"\
          table\"\n      }\n    },\n    {\n      \"type\": \"log\",\n      \"x\":\
          \ 12,\n      \"y\": 24,\n      \"width\": 12,\n      \"height\": 6,\n  \
          \    \"properties\": {\n        \"query\": \"SOURCE '${OCRFunctionLogGroup}'\
          \ | fields @timestamp, @logStream, @message | filter @message like /ERROR/\
          \ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^\
          \ ]*)/ | sort @timestamp desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"OCR Lambda Errors\",\n        \"view\": \"table\"\
          \n      }\n    },\n    {\n      \"type\": \"log\",\n      \"x\": 0,\n  \
          \    \"y\": 30,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\"\
          : {\n        \"query\": \"SOURCE '${ClassificationFunctionLogGroup}' | filter\
          \ @type = \\\"REPORT\\\" | fields @timestamp, @logStream, @billedDuration,\
          \ @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs}\
          \ | sort by @billedDuration desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Classification Lambda Long Running Invocations\"\
          ,\n        \"view\": \"table\"\n      }\n    },\n    {\n      \"type\":\
          \ \"log\",\n      \"x\": 12,\n      \"y\": 30,\n      \"width\": 12,\n \
          \     \"height\": 6,\n      \"properties\": {\n        \"query\": \"SOURCE\
          \ '${ClassificationFunctionLogGroup}' | fields @timestamp, @logStream, @message\
          \ | filter @message like /ERROR/ or @message like /Task timed out/ | parse\
          \ @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit\
          \ 20\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"\
          Classification Lambda Errors\",\n        \"view\": \"table\"\n      }\n\
          \    },\n    {\n      \"type\": \"log\",\n      \"x\": 0,\n      \"y\":\
          \ 36,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\"\
          : {\n        \"query\": \"SOURCE '${ExtractionFunctionLogGroup}' | filter\
          \ @type = \\\"REPORT\\\" | fields @timestamp, @logStream, @billedDuration,\
          \ @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs}\
          \ | sort by @billedDuration desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Extraction Lambda Long Running Invocations\",\n\
          \        \"view\": \"table\"\n      }\n    },\n    {\n      \"type\": \"\
          log\",\n      \"x\": 12,\n      \"y\": 36,\n      \"width\": 12,\n     \
          \ \"height\": 6,\n      \"properties\": {\n        \"query\": \"SOURCE '${ExtractionFunctionLogGroup}'\
          \ | fields @timestamp, @logStream, @message | filter @message like /ERROR/\
          \ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^\
          \ ]*)/ | sort @timestamp desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Extraction Lambda Errors\",\n        \"view\": \"\
          table\"\n      }\n    },\n    {\n      \"type\": \"log\",\n      \"x\":\
          \ 0,\n      \"y\": 42,\n      \"width\": 12,\n      \"height\": 6,\n   \
          \   \"properties\": {\n        \"query\": \"SOURCE '${AssessmentFunctionLogGroup}'\
          \ | filter @type = \\\"REPORT\\\" | fields @timestamp, @logStream, @billedDuration,\
          \ @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs}\
          \ | sort by @billedDuration desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Assessment Lambda Long Running Invocations\",\n\
          \        \"view\": \"table\"\n      }\n    },\n    {\n      \"type\": \"\
          log\",\n      \"x\": 12,\n      \"y\": 42,\n      \"width\": 12,\n     \
          \ \"height\": 6,\n      \"properties\": {\n        \"query\": \"SOURCE '${AssessmentFunctionLogGroup}'\
          \ | fields @timestamp, @logStream, @message | filter @message like /ERROR/\
          \ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^\
          \ ]*)/ | sort @timestamp desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Assessment Lambda Errors\",\n        \"view\": \"\
          table\"\n      }\n    },\n    {\n      \"type\": \"log\",\n      \"x\":\
          \ 0,\n      \"y\": 48,\n      \"width\": 12,\n      \"height\": 6,\n   \
          \   \"properties\": {\n        \"query\": \"SOURCE '${SummarizationFunctionLogGroup}'\
          \ | filter @type = \\\"REPORT\\\" | fields @timestamp, @logStream, @billedDuration,\
          \ @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs}\
          \ | sort by @billedDuration desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Summarization Lambda Long Running Invocations\"\
          ,\n        \"view\": \"table\"\n      }\n    },\n    {\n      \"type\":\
          \ \"log\",\n      \"x\": 12,\n      \"y\": 48,\n      \"width\": 12,\n \
          \     \"height\": 6,\n      \"properties\": {\n        \"query\": \"SOURCE\
          \ '${SummarizationFunctionLogGroup}' | fields @timestamp, @logStream, @message\
          \ | filter @message like /ERROR/ or @message like /Task timed out/ | parse\
          \ @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit\
          \ 20\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"\
          Summarization Lambda Errors\",\n        \"view\": \"table\"\n      }\n \
          \   },\n    {\n      \"type\": \"metric\",\n      \"x\": 16,\n      \"y\"\
          : 24,\n      \"width\": 8,\n      \"height\": 6,\n      \"properties\":\
          \ {\n        \"metrics\": [\n          [\"AWS/Lambda\", \"Duration\", \"\
          FunctionName\", \"${RuleValidationFunction}\"]\n        ],\n        \"region\"\
          : \"${AWS::Region}\",\n        \"title\": \"Rule Validation Function Duration\"\
          ,\n        \"period\": 300,\n        \"annotations\": {\n          \"horizontal\"\
          : [{\n            \"value\": ${ExecutionTimeThresholdMs},\n            \"\
          label\": \"Threshold (${ExecutionTimeThresholdMs}ms)\",\n            \"\
          color\": \"#ff0000\"\n          }]\n        },\n        \"stat\": \"Average\"\
          ,\n        \"view\": \"timeSeries\"\n      }\n    },\n    {\n      \"type\"\
          : \"log\",\n      \"x\": 0,\n      \"y\": 54,\n      \"width\": 12,\n  \
          \    \"height\": 6,\n      \"properties\": {\n        \"query\": \"SOURCE\
          \ '${RuleValidationFunctionLogGroup}' | filter @type = \\\"REPORT\\\" |\
          \ fields @timestamp, @logStream, @billedDuration, @maxMemoryUsed/1024/1024\
          \ as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs}\
          \ | sort by @billedDuration desc | limit 20\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"title\": \"Rule Validation Lambda Long Running Invocations\"\
          ,\n        \"view\": \"table\"\n      }\n    },\n    {\n      \"type\":\
          \ \"log\",\n      \"x\": 12,\n      \"y\": 54,\n      \"width\": 12,\n \
          \     \"height\": 6,\n      \"properties\": {\n        \"query\": \"SOURCE\
          \ '${RuleValidationFunctionLogGroup}' | fields @timestamp, @logStream, @message\
          \ | filter @message like /ERROR/ or @message like /Task timed out/ | parse\
          \ @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit\
          \ 20\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"\
          Rule Validation Lambda Errors\",\n        \"view\": \"table\"\n      }\n\
          \    }\n  ]\n}\n"
    Metadata:
      SamResourceId: Dashboard
Outputs:
  StateMachineName:
    Description: Step Functions State machine Name
    Value:
      Fn::GetAtt:
      - DocumentProcessingStateMachine
      - Name
  StateMachineArn:
    Description: Step Functions State machine ARN
    Value:
      Fn::GetAtt:
      - DocumentProcessingStateMachine
      - Arn
  StateMachineLogGroup:
    Description: Step Functions State machine LogGroup
    Value:
      Ref: StateMachineLogGroup
  PatternLogGroups:
    Description: Comma-separated list of pattern-specific log groups
    Value:
      Fn::Join:
      - ','
      - - Ref: OCRFunctionLogGroup
        - Ref: ClassificationFunctionLogGroup
        - Ref: ExtractionFunctionLogGroup
        - Ref: AssessmentFunctionLogGroup
        - Ref: ProcessResultsFunctionLogGroup
        - Ref: SummarizationFunctionLogGroup
        - Ref: RuleValidationFunctionLogGroup
        - Ref: RuleValidationOrchestrationFunctionLogGroup
        - Ref: StateMachineLogGroup
  DashboardName:
    Description: Name of the Pattern 2 (Bedrock FMs) CloudWatch Dashboard
    Value:
      Ref: Dashboard
  DashboardArn:
    Description: ARN of the Pattern 2 (Bedrock FMs) CloudWatch Dashboard
    Value:
      Fn::Sub: arn:${AWS::Partition}:cloudwatch::${AWS::AccountId}:dashboard/${Dashboard}
